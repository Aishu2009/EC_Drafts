#include "Arduino.h"
#include <BasicEncoder.h>
#include <Keypad.h>

// mode selection
int currentMode = 0;   // 1=red, 2=blue, 3=yellow

// each color has its own brightness value (0â€“100)
int redValue = 0;
int blueValue = 0;
int yellowValue = 0;

// RGB LED pins
const int red = 10;
const int blue = 11;
const int yellow = 9;

// encoder pins
const int clock = 3;
const int dio = 2;

// keypad setup
const int ROWS = 1;
const int COLS = 4;
const char COLOR[ROWS][COLS] = { {'1','2','3','4'} };

const byte ROW_PINS[ROWS] = { 5 };
const byte COL_PINS[COLS] = { 6, 7, 8, 13 };

Keypad heroKeypad = Keypad(makeKeymap(COLOR), ROW_PINS, COL_PINS, ROWS, COLS);
BasicEncoder depth_control(clock, dio);

void setup() {
  pinMode(red, OUTPUT);
  pinMode(blue, OUTPUT);
  pinMode(yellow, OUTPUT);
}

void loop() {

  char button_character = heroKeypad.getKey();

  // update mode when a key is pressed
  if (button_character != NO_KEY) {
    if (button_character == '1') currentMode = 1;
    if (button_character == '2') currentMode = 2;
    if (button_character == '3') currentMode = 3;
  }

  // run the selected mode continuously
  if (currentMode == 1) adjustRed();
  if (currentMode == 2) adjustBlue();
  if (currentMode == 3) adjustYellow();

  // always display the mixed color
  analogWrite(red,   map(redValue,   0, 100, 0, 255));
  analogWrite(blue,  map(blueValue,  0, 100, 0, 255));
  analogWrite(yellow,map(yellowValue,0, 100, 0, 255));
}

void adjustRed() {
  depth_control.service();
  int change = depth_control.get_change();
  redValue += change;

  if (redValue < 0) redValue = 0;
  if (redValue > 100) redValue = 100;
}

void adjustBlue() {
  depth_control.service();
  int change = depth_control.get_change();
  blueValue += change;

  if (blueValue < 0) blueValue = 0;
  if (blueValue > 100) blueValue = 100;
}

void adjustYellow() {
  depth_control.service();
  int change = depth_control.get_change();
  yellowValue += change;

  if (yellowValue < 0) yellowValue = 0;
  if (yellowValue > 100) yellowValue = 100;
}
